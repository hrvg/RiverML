<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Making predictions • RiverML</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Making predictions">
<meta property="og:description" content="RiverML">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">RiverML</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/RiverML.html">Get started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Data preparation</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/make_target_dataset.html">Making the target dataset</a>
        </li>
        <li>
          <a href="../articles/make_training_dataset.html">Making the training dataset</a>
        </li>
      </ul>
</li>
    <li class="divider">
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Machine learning models</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/ML_training.html">Training complete benchmark</a>
        </li>
        <li>
          <a href="../articles/processing_benchmark_results.html">Processing benchmark results</a>
        </li>
        <li>
          <a href="../articles/making_predictions.html">Making predictions</a>
        </li>
      </ul>
</li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="making_predictions_files/header-attrs-2.5/header-attrs.js"></script><link href="making_predictions_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="making_predictions_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Making predictions</h1>
            
      
      
      <div class="hidden name"><code>making_predictions.Rmd</code></div>

    </div>

    
    
<div id="purpose" class="section level1">
<h1 class="hasAnchor">
<a href="#purpose" class="anchor"></a>Purpose</h1>
<p>Once final optimal models have been trained, predictions can be made.</p>
</div>
<div id="libraries" class="section level1">
<h1 class="hasAnchor">
<a href="#libraries" class="anchor"></a>Libraries</h1>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">RiverML</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">magrittr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">raster</span>)
<span class="co">#&gt; Loading required package: sp</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'raster'</span>
<span class="co">#&gt; The following object is masked from 'package:magrittr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     extract</span></pre></body></html></div>
</div>
<div id="initialization" class="section level1">
<h1 class="hasAnchor">
<a href="#initialization" class="anchor"></a>Initialization</h1>
<p>The first step in making predictions is retrieving the trained models and parameters from the benchmark. As it is likely that the users are running more than one iterations of one benchmark (or in general more than one benchmark), this is handled by the <code>PATH</code> variable. This is similar to the <code>PATH</code> specified when <a href="articles/ML_training.html">training the models</a>.</p>
<p>The <code>PATH</code> directory should contains a <code>PARAMETERS.Rds</code> corresponding to the final model parameters. We can retrieve the parameters we need from it with:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">PARAMETERS</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">PATH</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"PARAMETERS.Rds"</span>)))
<span class="no">PROB</span> <span class="kw">&lt;-</span> <span class="no">PARAMETERS</span>$<span class="no">PROB</span>
<span class="no">PREPROC</span> <span class="kw">&lt;-</span> <span class="no">PARAMETERS</span>$<span class="no">PREPROC</span>
<span class="no">REGIONS</span> <span class="kw">&lt;-</span> <span class="no">PARAMETERS</span>$<span class="no">REGIONS</span>
<span class="no">LRN_IDS</span> <span class="kw">&lt;-</span> <span class="no">PARAMETERS</span>$<span class="no">LRN_IDS</span></pre></body></html></div>
<p>We also have to specify if feature selection has been activated. If so: <code>TUNE_FS &lt;- TRUE</code> and we have to edit the <code>PATH</code> variable. Additionally we perform some cosmetic changes in the <code>.id</code> variables and filter for the learners that have a final model.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="kw">if</span> (<span class="no">TUNE_FS</span>){
    <span class="no">PATH</span> <span class="kw">&lt;-</span> <span class="st">"F:/hguillon/research/FS_MI_corr2"</span>
    <span class="no">bestFeatureSets</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"./data/FS/bestFeatureSets.Rds"</span>) <span class="kw">%&gt;%</span>
        <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(
            <span class="kw">learner.id</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"classif."</span>, <span class="no">learner.id</span>),
            <span class="kw">task.id</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"SAC"</span>, <span class="st">"ALLSAC"</span>, <span class="no">task.id</span>)
        ) <span class="kw">%&gt;%</span>
        <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">learner.id</span> <span class="kw">%in%</span> <span class="no">LRN_IDS</span>)
}</pre></body></html></div>
</div>
<div id="computing-predictions" class="section level1">
<h1 class="hasAnchor">
<a href="#computing-predictions" class="anchor"></a>Computing predictions</h1>
<div id="uncalibrated-predictions-on-the-training-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#uncalibrated-predictions-on-the-training-dataset" class="anchor"></a>Uncalibrated predictions on the training dataset</h2>
<p>Obtaining the predictions for the training dataset is handled with <code><a href="../reference/get_predictions.html">get_predictions()</a></code> with <code>TARGET = FALSE</code>.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">training_preds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/get_predictions.html">get_predictions</a></span>(<span class="no">REGIONS</span>, <span class="no">LRN_IDS</span>, <span class="no">PATH</span>, <span class="kw">TARGET</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="no">TUNE_FS</span>)</pre></body></html></div>
</div>
<div id="uncalibrated-predictions-on-the-target-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#uncalibrated-predictions-on-the-target-dataset" class="anchor"></a>Uncalibrated predictions on the target dataset</h2>
<p>Obtaining the predictions for the target dataset is handled with <code><a href="../reference/get_predictions.html">get_predictions()</a></code> with <code>TARGET = TRUE</code>.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">target_preds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/get_predictions.html">get_predictions</a></span>(<span class="no">REGIONS</span>, <span class="no">LRN_IDS</span>, <span class="no">PATH</span>, <span class="kw">TARGET</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="no">TUNE_FS</span>)</pre></body></html></div>
</div>
<div id="calibrating-predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#calibrating-predictions" class="anchor"></a>Calibrating predictions</h2>
<p>Most machine learning models output posterior probabilities that often require calibration. Such calibration corrects for the potential distortion of the posterior probabilities when compared to empirical probabilities and improves model performance <span class="citation">(DeGroot and Fienberg 1983; Zadrozny 2002; Niculescu-Mizil and Caruana 2005)</span>. Given the sigmoid-shape of most distortions, <span class="citation">(Platt and others 1999)</span> proposed a sigmoid calibration to address this effect. This is the so-called Platt’s scaling. Other useful approaches include Bayesian calibration and isotonic scaling <span class="citation">(Zadrozny and Elkan 2002)</span> which both require binarizing the problem. Useful references on binarization includes <span class="citation">Platt, Cristianini, and Shawe-Taylor (2000)</span>; <span class="citation">Kijsirikul and Ussivakul (2002)</span>; <span class="citation">Dong, Frank, and Kramer (2005)</span>; <span class="citation">Lorena and Carvalho (2010)</span>; <span class="citation">Quiterio and Lorena (2016)</span>; <span class="citation">Adnan and Islam (2015)</span>; <span class="citation">Melnikov and Hüllermeier (2018)</span>. In this study, posterior calibration was performed using a multinomial regression; a straightforward extension of the binomial case corresponding to the logistic Platt’s scaling. We use the <code>R</code> package <code>glmnet</code> to fit a generalized linear model with an elastic net penalty and with a 10-fold cross-validation with the function <code><a href="../reference/get_calibrations.html">get_calibrations()</a></code>.</p>
<p>The option <code>plot = TRUE</code> returns a calibration plot which highlights the amount of calibration per class. It is always a good sign when the predictions do not require a large amount of correction and is a qualitative check on the performance of one or multiple models. Finally, note that the calibration are performed with the original and possibly unequally sampled training dataset.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">calibrations</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/get_calibrations.html">get_calibrations</a></span>(<span class="no">REGIONS</span>, <span class="no">LRN_IDS</span>, <span class="no">training_preds</span>, <span class="kw">plot</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
</div>
<div id="making-calibrated-predictions" class="section level2">
<h2 class="hasAnchor">
<a href="#making-calibrated-predictions" class="anchor"></a>Making calibrated predictions</h2>
<p>Once the <code>calibrations</code> have been derived, <code><a href="../reference/calibrated_predictions.html">calibrated_predictions()</a></code> calibrates the target predictions:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">cal_preds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/calibrated_predictions.html">calibrated_predictions</a></span>(<span class="no">REGIONS</span>, <span class="no">LRN_IDS</span>, <span class="no">target_preds</span>, <span class="no">calibrations</span>)</pre></body></html></div>
</div>
</div>
<div id="spatially-distributing-the-predictions" class="section level1">
<h1 class="hasAnchor">
<a href="#spatially-distributing-the-predictions" class="anchor"></a>Spatially distributing the predictions</h1>
<p>Because this step of the workflow write a number of file, it is easier to run it within a loop statement. Before we dive into the different stage of said loop, some variables have to be initialized. <code>entropy_rate</code> describes the instability of the predictions from a transition probability point-of-view. <code>regional_entropy</code> describes the instability of the predictions over the entire prediction region.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">entropy_rate</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">LRN_IDS</span>))), <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">REGIONS</span>))
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span>(<span class="no">entropy_rate</span>) <span class="kw">&lt;-</span> <span class="no">REGIONS</span>
<span class="kw">for</span> (<span class="no">region</span> <span class="kw">in</span> <span class="no">REGIONS</span>) <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span>(<span class="no">entropy_rate</span><span class="kw">[[</span><span class="no">region</span>]]) <span class="kw">&lt;-</span> <span class="no">LRN_IDS</span>

<span class="no">regional_entropy</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">LRN_IDS</span>) + <span class="fl">1</span>)), <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">REGIONS</span>))
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span>(<span class="no">regional_entropy</span>) <span class="kw">&lt;-</span> <span class="no">REGIONS</span>
<span class="kw">for</span> (<span class="no">region</span> <span class="kw">in</span> <span class="no">REGIONS</span>) <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span>(<span class="no">regional_entropy</span><span class="kw">[[</span><span class="no">region</span>]]) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"training"</span>, <span class="no">LRN_IDS</span>)</pre></body></html></div>
<p>We can then enter the loop over area of studies:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r">for (region in REGIONS){</pre></body></html></div>
<p>First we retrieve the target streamlines with:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">.target_streamlines</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/get_target_streamlines.html">get_target_streamlines</a></span>(<span class="no">region</span>)</pre></body></html></div>
<p>Then we enter the loop over the ML models:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r">    for (lrn in LRN_IDS){
        target_streamlines &lt;- .target_streamlines
        predictions_df &lt;- as.data.frame(cal_preds[[region]][[lrn]])</pre></body></html></div>
<p>If there are post-hoc heuristics, this is where one would implement them. For example, one heuristic could be to assign a class based on the Strahler’s order, here the class <code>K03</code> in region <code>K</code>.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r">        <span class="kw">if</span> (<span class="no">region</span> <span class="kw">==</span> <span class="st">"K"</span>){
            <span class="no">predictions_df</span>[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">target_streamlines</span>$<span class="no">StreamOrde</span> <span class="kw">&gt;=</span> <span class="fl">5</span>), <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"K03"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">predictions_df</span>))] <span class="kw">&lt;-</span> <span class="fl">1</span>
            <span class="no">rSum</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/rowSums.html">rowSums</a></span>(<span class="no">predictions_df</span>)
            <span class="no">predictions_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span>(<span class="no">predictions_df</span>, <span class="fl">1</span>, <span class="no">rSum</span>,<span class="st">'/'</span>)
        }</pre></body></html></div>
<p>A good check to implement is to ensure that all predictions sum to one (bar some rounding errors).</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r">        <span class="no">check</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">predictions_df</span>, <span class="fl">1</span>, <span class="no">sum</span>)
        <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span>(<span class="no">check</span> <span class="kw">&gt;=</span> <span class="fl">1</span> - <span class="fl">1E-9</span>))</pre></body></html></div>
<p>We can retrieve the response as being the class with the highest probability. Another sanity check at this step is to investigate the distribution of the predicted classes over the entire region. Such a check can uncover early on (that is before any mapping) that some classes are under-represented in the predictions.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r">        <span class="no">lvls</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"prob."</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">predictions_df</span>))
        <span class="no">target_predictions</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">predictions_df</span>, <span class="kw">MARGIN</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">FUN</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">row</span>){
            <span class="no">lvls</span>[<span class="fu"><a href="https://rdrr.io/pkg/raster/man/which.minmax.html">which.max</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">row</span>))]
        })
        <span class="no">target_predictions</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/factor.html">as.factor</a></span>(<span class="no">target_predictions</span>)
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">target_predictions</span>))</pre></body></html></div>
<p>From the probabilistic predictions, we can derive a number of metrics of their distribution at the regional level which <code><a href="../reference/shannon_weiner.html">shannon_weiner()</a></code>, <code><a href="../reference/richness.html">richness()</a></code> and <code><a href="../reference/simpson_evenness.html">simpson_evenness()</a></code>. Again, this is useful at this stage to capture the potential difference between the distribution of the training labels and the predictions over the entire region. If the sampling of the training dataset has been correctly stratified before, one would expect that at the region level the distribution of the predictions is close to the one of the training labels. If that is not the case, that might indicate some issues with the generalization of the learned patterns.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r">        <span class="no">shannon_network_training</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/shannon_weiner.html">shannon_weiner</a></span>(<span class="no">training_preds</span><span class="kw">[[</span><span class="no">region</span>]]$<span class="no">labels</span>, <span class="kw">units</span> <span class="kw">=</span> <span class="fl">2</span>)
        <span class="no">richness_network_training</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/richness.html">richness</a></span>(<span class="no">training_preds</span><span class="kw">[[</span><span class="no">region</span>]]$<span class="no">labels</span>)
        <span class="no">simpson_evenness_network_training</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/simpson_evenness.html">simpson_evenness</a></span>(<span class="no">training_preds</span><span class="kw">[[</span><span class="no">region</span>]]$<span class="no">labels</span>)

        <span class="no">shannon_network_target</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/shannon_weiner.html">shannon_weiner</a></span>(<span class="no">target_predictions</span>, <span class="kw">units</span> <span class="kw">=</span> <span class="fl">2</span>)
        <span class="no">richness_network_target</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/richness.html">richness</a></span>(<span class="no">target_predictions</span>)
        <span class="no">simpson_evenness_network_target</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/simpson_evenness.html">simpson_evenness</a></span>(<span class="no">target_predictions</span>)

        <span class="no">metrics_df</span> <span class="kw">&lt;-</span> <span class="fu">data_frame</span>(<span class="kw">training</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">richness_network_training</span>, <span class="no">simpson_evenness_network_training</span>, <span class="no">shannon_network_training</span>),
            <span class="kw">target</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">richness_network_target</span>, <span class="no">simpson_evenness_network_target</span>, <span class="no">shannon_network_target</span>))
        <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">metrics_df</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Richness"</span>, <span class="st">"Simpson's evenness"</span>, <span class="st">"Shannon-Weiner's value"</span>)
        <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">metrics_df</span>)
        <span class="kw">if</span> (<span class="no">richness_network_target</span> <span class="kw">!=</span> <span class="no">richness_network_training</span>) <span class="fu"><a href="https://rdrr.io/r/base/warning.html">warning</a></span>(<span class="st">"One of the class is not predicted at all over the whole network!"</span>)</pre></body></html></div>
<p>These metrics can be extended at the stream interval level, that is at the instance level.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r">        <span class="no">shannon_segments</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">predictions_df</span>, <span class="kw">MARGIN</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">FUN</span> <span class="kw">=</span> <span class="no">shannon_weiner</span>, <span class="kw">.prob_bool</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">units</span> <span class="kw">=</span> <span class="fl">2</span>)
        <span class="no">richness_segments</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">predictions_df</span>, <span class="kw">MARGIN</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">FUN</span> <span class="kw">=</span> <span class="no">richness</span>)
        <span class="no">evenness_segments</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">predictions_df</span>, <span class="kw">MARGIN</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">FUN</span> <span class="kw">=</span> <span class="no">simpson_evenness</span>, <span class="kw">.prob_bool</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p>We can now assign these values to the target streamlines and save the results into a <code>.shp</code> shapefile.</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r">        <span class="no">target_streamlines</span>$<span class="no">group</span> <span class="kw">&lt;-</span> <span class="no">target_predictions</span>
        <span class="no">target_streamlines</span>$<span class="no">shannon</span> <span class="kw">&lt;-</span> <span class="no">shannon_segments</span>
        <span class="no">target_streamlines</span>$<span class="no">richness</span> <span class="kw">&lt;-</span> <span class="no">richness_segments</span>
        <span class="no">target_streamlines</span>$<span class="no">evenness</span> <span class="kw">&lt;-</span> <span class="no">evenness_segments</span>
        <span class="no">nc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">ncol</a></span>(<span class="no">target_streamlines</span>)
        <span class="no">target_streamlines</span>@<span class="kw">data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">target_streamlines</span>@<span class="kw">data</span>, <span class="no">predictions_df</span>)
        <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span>(<span class="no">target_streamlines</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/headtail.html">head</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span>(<span class="no">target_streamlines</span>), <span class="no">nc</span>), <span class="no">lvls</span>)

        <span class="no">fname</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">PATH</span>, <span class="st">"/"</span>, <span class="no">region</span>), <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">region</span>, <span class="st">'_'</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"classif."</span>, <span class="st">""</span>, <span class="no">lrn</span>) ,<span class="st">'_calibrated_predictions'</span>))
        <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">fname</span>, <span class="st">".shp"</span>))){
            <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.remove</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">fname</span>, <span class="st">".shp"</span>)) <span class="co"># clean the attribute names in the shapefile</span>
            <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.remove</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">fname</span>, <span class="st">".prj"</span>)) <span class="co"># clean the attribute names in the shapefile</span>
            <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.remove</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">fname</span>, <span class="st">".shx"</span>)) <span class="co"># clean the attribute names in the shapefile</span>
            <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.remove</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">fname</span>, <span class="st">".dbf"</span>)) <span class="co"># clean the attribute names in the shapefile</span>
        }
        <span class="fu"><a href="https://rdrr.io/pkg/raster/man/shapefile.html">shapefile</a></span>(<span class="no">target_streamlines</span>[<span class="no">ind</span>, ], <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">fname</span>, <span class="st">".shp"</span>), <span class="kw">overwrite</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p>We now turn to the calculation of the entropy rate. This is derived from the transition probability matrix which we first have to compute. We first turn the <code>target_streamlines</code> into a network that we can work on with the <code>igraph</code> package. This allows to derive the incident edges at each vertex and thus which class is connected to which other. When we average this connectivity matrix over the entire network we obtain the probability of transition between the different classes. We can readily use this transition probability matrix to derive the entropy rate, that is the limit value of entropy (or surprise) while one walks along the stream network.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r">        <span class="no">numeric_group</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/factor.html">as.factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">target_streamlines</span>$<span class="no">group</span>)))
        <span class="no">fname</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">PATH</span>, <span class="st">"/"</span>, <span class="no">region</span>), <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">lrn</span>, <span class="st">".Rds"</span>))
        <span class="no">streamlines_network</span> <span class="kw">&lt;-</span> <span class="kw pkg">sfnetworks</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/sfnetworks/man/as_sfnetwork.html">as_sfnetwork</a></span>(<span class="kw pkg">sf</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_as_sf.html">st_as_sf</a></span>(<span class="no">target_streamlines</span>), <span class="kw">directed</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
        <span class="no">igraph_object</span> <span class="kw">&lt;-</span> <span class="kw pkg">igraph</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/as.igraph.html">as.igraph</a></span>(<span class="no">streamlines_network</span>)
        <span class="no">ie</span> <span class="kw">&lt;-</span> <span class="kw pkg">igraph</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/igraph/man/incident_edges.html">incident_edges</a></span>(<span class="no">igraph_object</span>, <span class="fu">V</span>(<span class="no">igraph_object</span>))
        <span class="no">ie_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">ie</span>, <span class="kw">function</span>(<span class="no">es</span>)  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">numeric_group</span>[<span class="fu">as_ids</span>(<span class="no">es</span>)])))
        <span class="no">ie_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="no">rbind</span>, <span class="no">ie_list</span>)
        <span class="no">ie_df</span> <span class="kw">&lt;-</span> <span class="no">ie_df</span>[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/rowSums.html">rowSums</a></span>(<span class="no">ie_df</span>) <span class="kw">&gt;=</span> <span class="fl">2</span>), ]

        <span class="no">ie_count</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">ncol</a></span>(<span class="no">ie_df</span>)), <span class="kw">function</span>(<span class="no">i</span>){
            <span class="no">.df</span> <span class="kw">&lt;-</span> <span class="no">ie_df</span>[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">ie_df</span>[, <span class="no">i</span>] <span class="kw">&gt;</span> <span class="fl">0</span>), ]
            <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">ncol</a></span>(<span class="no">ie_df</span>)), <span class="kw">function</span>(<span class="no">j</span>){
                <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">i</span><span class="kw">==</span><span class="no">j</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">.df</span>[<span class="no">.df</span>[, <span class="no">j</span>] <span class="kw">&gt;</span> <span class="fl">1</span>, <span class="no">j</span>]), <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">.df</span>[, <span class="no">j</span>]))
            })
        })
        <span class="no">count_matrix</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="no">rbind</span>, <span class="no">ie_count</span>)
        <span class="no">prob_matrix</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span>(<span class="no">count_matrix</span>, <span class="kw">MARGIN</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/rowSums.html">rowSums</a></span>(<span class="no">count_matrix</span>), <span class="st">"/"</span>)
        <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">prob_matrix</span>, <span class="no">fname</span>)

        <span class="no">H</span> <span class="kw">&lt;-</span> <span class="kw pkg">ccber</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/ccber/man/CalcMarkovEntropyRate.html">CalcMarkovEntropyRate</a></span>(<span class="no">prob_matrix</span>, <span class="kw pkg">ccber</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/ccber/man/CalcEigenStationary.html">CalcEigenStationary</a></span>(<span class="no">prob_matrix</span>))
        <span class="no">entropy_rate</span><span class="kw">[[</span><span class="no">region</span>]]<span class="kw">[[</span><span class="no">lrn</span>]] <span class="kw">&lt;-</span> <span class="no">H</span>
        <span class="no">regional_entropy</span><span class="kw">[[</span><span class="no">region</span>]]$<span class="no">training</span> <span class="kw">&lt;-</span> <span class="no">shannon_network_training</span>
        <span class="no">regional_entropy</span><span class="kw">[[</span><span class="no">region</span>]]<span class="kw">[[</span><span class="no">lrn</span>]] <span class="kw">&lt;-</span> <span class="no">shannon_network_target</span></pre></body></html></div>
<p>Let’s not forget to exit the loop over learners and the one over regions:</p>
<pre><code>    }
}</code></pre>
<p>Finally, <code><a href="../reference/get_entropy_df.html">get_entropy_df()</a></code> function provides some formatting for the <code>entropy_rate</code> list.</p>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references hanging-indent">
<div id="ref-Adnan2015">
<p>Adnan, Md Nasim, and Md Zahidul Islam. 2015. “One-Vs-All Binarization Technique in the Context of Random Forest.” In <em>Proceedings of the European Symposium on Artificial Neural Networks, Computational Intelligence and Machine Learning</em>, 385–90.</p>
</div>
<div id="ref-DeGroot1983">
<p>DeGroot, Morris H, and Stephen E Fienberg. 1983. “The Comparison and Evaluation of Forecasters.” <em>Journal of the Royal Statistical Society: Series D (the Statistician)</em> 32 (1-2): 12–22.</p>
</div>
<div id="ref-Dong2005">
<p>Dong, Lin, Eibe Frank, and Stefan Kramer. 2005. “Ensembles of Balanced Nested Dichotomies for Multi-Class Problems.” In <em>European Conference on Principles of Data Mining and Knowledge Discovery</em>, 84–95. Springer.</p>
</div>
<div id="ref-Kijsirikul2002">
<p>Kijsirikul, B., and N. Ussivakul. 2002. “Multiclass Support Vector Machines Using Adaptive Directed Acyclic Graph.” In <em>Proceedings of the 2002 International Joint Conference on Neural Networks. IJCNN02 (Cat. No.02CH37290)</em>. IEEE. <a href="https://doi.org/10.1109/ijcnn.2002.1005608">https://doi.org/10.1109/ijcnn.2002.1005608</a>.</p>
</div>
<div id="ref-Lorena2010">
<p>Lorena, Ana Carolina, and André C. P. L. F. de Carvalho. 2010. “Building Binary-Tree-Based Multiclass Classifiers Using Separability Measures.” <em>Neurocomputing</em> 73 (16-18): 2837–45. <a href="https://doi.org/10.1016/j.neucom.2010.03.027">https://doi.org/10.1016/j.neucom.2010.03.027</a>.</p>
</div>
<div id="ref-Melnikov2018">
<p>Melnikov, Vitalik, and Eyke Hüllermeier. 2018. “On the Effectiveness of Heuristics for Learning Nested Dichotomies: An Empirical Analysis.” <em>Machine Learning</em>, June. <a href="https://doi.org/10.1007/s10994-018-5733-1">https://doi.org/10.1007/s10994-018-5733-1</a>.</p>
</div>
<div id="ref-Niculescu-Mizil2005">
<p>Niculescu-Mizil, Alexandru, and Rich Caruana. 2005. “Predicting Good Probabilities with Supervised Learning.” In <em>Proceedings of the 22nd International Conference on Machine Learning - ICML 05</em>. ACM Press. <a href="https://doi.org/10.1145/1102351.1102430">https://doi.org/10.1145/1102351.1102430</a>.</p>
</div>
<div id="ref-Platt2000">
<p>Platt, John C, Nello Cristianini, and John Shawe-Taylor. 2000. “Large Margin Dags for Multiclass Classification.” In <em>Advances in Neural Information Processing Systems</em>, 547–53.</p>
</div>
<div id="ref-Platt1999">
<p>Platt, John, and others. 1999. “Probabilistic Outputs for Support Vector Machines and Comparisons to Regularized Likelihood Methods.” <em>Advances in Large Margin Classifiers</em> 10 (3): 61–74.</p>
</div>
<div id="ref-Quiterio2016">
<p>Quiterio, Thaise M, and Ana C Lorena. 2016. “Determining the Structure of Decision Directed Acyclic Graphs for Multiclass Classification Problems.” In <em>Intelligent Systems (Bracis), 2016 5th Brazilian Conference on</em>, 115–20. IEEE.</p>
</div>
<div id="ref-Zadrozny2002a">
<p>Zadrozny, Bianca. 2002. “Reducing Multiclass to Binary by Coupling Probability Estimates.” In <em>Advances in Neural Information Processing Systems</em>, 1041–8.</p>
</div>
<div id="ref-Zadrozny2002">
<p>Zadrozny, Bianca, and Charles Elkan. 2002. “Transforming Classifier Scores into Accurate Multiclass Probability Estimates.” In <em>Proceedings of the Eighth Acm Sigkdd International Conference on Knowledge Discovery and Data Mining</em>, 694–99. ACM.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Hervé Guillon.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
